<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>估值宝 · 简单好用的基金估值工具</title>
  <meta name="description" content="估值宝是一款简单好用的基金估值查询工具，支持快速查看基金当前估值情况，帮助你轻松判断买卖时机，适合日常参考，不构成投资建议。">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#64748b',
            success: '#10b981',
            danger: '#ef4444',
            warning: '#f59e0b',
            light: '#f8fafc',
            dark: '#1e293b',
            up: '#ef4444',
            down: '#10b981',
            flat: '#64748b'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-hover {
        @apply transition-all duration-300 hover:shadow-lg hover:border-l-4 hover:border-primary;
      }
      .tab-active {
        @apply border-b-2 border-primary text-primary font-medium;
      }
      .btn {
        @apply px-4 py-2 rounded-md font-medium transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2;
      }
      .btn-primary {
        @apply bg-primary text-white hover:bg-primary/90 focus:ring-primary/50;
      }
      .btn-secondary {
        @apply bg-secondary text-white hover:bg-secondary/90 focus:ring-secondary/50;
      }
      .btn-danger {
        @apply bg-danger text-white hover:bg-danger/90 focus:ring-danger/50;
      }
      .input {
        @apply px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200;
      }
      .modal-enter {
        @apply opacity-0 scale-95;
      }
      .modal-enter-active {
        @apply opacity-100 scale-100 transition-all duration-300;
      }
      .modal-exit {
        @apply opacity-100 scale-100;
      }
      .modal-exit-active {
        @apply opacity-0 scale-95 transition-all duration-300;
      }
      .fade-enter {
        @apply opacity-0;
      }
      .fade-enter-active {
        @apply opacity-100 transition-opacity duration-300;
      }
      .fade-exit {
        @apply opacity-100;
      }
      .fade-exit-active {
        @apply opacity-0 transition-opacity duration-300;
      }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">
  <!-- 顶部导航 -->
  <header class="bg-white shadow-sm">
    <div class="container mx-auto px-4 py-4">
      <div class="flex justify-between items-center mb-4">
        <button id="back-btn" class="px-3 py-1 rounded-md text-sm font-medium bg-secondary text-white hover:bg-secondary/90 hidden" onclick="goBack()">
          <i class="fa fa-arrow-left mr-1"></i>返回
        </button>
        <div class="flex items-center justify-center flex-1 gap-2">
          <img src="https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=Simple%20modern%20logo%20for%20financial%20tool%20called%20%22GuZhiBao%22%20with%20chart%20icon%20and%20blue%20color%20scheme&image_size=square" alt="估值宝" class="w-10 h-10 rounded-full">
          <h1 class="text-2xl font-bold text-center text-primary">估值宝</h1>
        </div>
        <div class="flex items-center gap-2">
          <button id="theme-toggle" class="p-2 rounded-md hover:bg-gray-200" onclick="toggleTheme()" title="切换主题">
            <i class="fa fa-sun-o"></i>
          </button>
        </div>
      </div>
      <p class="text-center text-gray-500 mt-1">简单好用的基金估值工具，助你把握投资时机</p>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="container mx-auto px-3 py-4">
    <!-- 选项卡 -->
    <div class="flex border-b border-gray-200 mb-4">
      <button id="tab-home" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700" onclick="switchTab('home')">
        首页
      </button>
      <button id="tab-query" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700" onclick="switchTab('query')">
        估值查询
      </button>
      <button id="tab-position" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700" onclick="switchTab('position')">
        我的持仓
      </button>
      <button id="tab-ranking" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700" onclick="switchTab('ranking')">
        涨跌榜
      </button>
      <button id="tab-news" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700" onclick="switchTab('news')">
        新闻资讯
      </button>
    </div>

    <!-- 首页面板 -->
    <div id="panel-home" class="fade-enter-active">
      <!-- 网站介绍 -->
      <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
        <div class="flex flex-col md:flex-row items-center gap-4">
          <div class="flex-1">
            <h1 class="text-xl font-bold text-primary mb-2">欢迎使用估值宝</h1>
            <p class="text-gray-600 mb-4">一款简单好用的基金估值查询工具，支持快速查看基金当前估值情况，帮助你轻松判断买卖时机，适合日常参考，不构成投资建议。</p>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              <div class="text-center p-3 bg-gray-50 rounded-lg">
                <i class="fa fa-line-chart text-primary text-xl mb-1"></i>
                <p class="text-xs font-medium">实时估值</p>
              </div>
              <div class="text-center p-3 bg-gray-50 rounded-lg">
                <i class="fa fa-list-ol text-primary text-xl mb-1"></i>
                <p class="text-xs font-medium">涨跌榜</p>
              </div>
              <div class="text-center p-3 bg-gray-50 rounded-lg">
                <i class="fa fa-briefcase text-primary text-xl mb-1"></i>
                <p class="text-xs font-medium">持仓管理</p>
              </div>
              <div class="text-center p-3 bg-gray-50 rounded-lg">
                <i class="fa fa-newspaper-o text-primary text-xl mb-1"></i>
                <p class="text-xs font-medium">新闻资讯</p>
              </div>
            </div>
          </div>
          <div class="w-40 h-40 flex-shrink-0">
            <img src="https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=Financial%20investment%20dashboard%20with%20fund%20valuation%20charts%20and%20data%20visualization&image_size=square" alt="估值宝" class="w-full h-full object-cover rounded-lg shadow-sm">
          </div>
        </div>
      </div>

      <!-- 快速操作区 -->
      <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
        <h2 class="text-md font-semibold mb-3">快速查询</h2>
        <div class="flex flex-col md:flex-row gap-3">
          <input
            type="text"
            id="home-fund-code"
            class="input flex-1"
            placeholder="请输入基金代码或基金名称"
          >
          <button class="btn btn-primary whitespace-nowrap" onclick="homeQueryFund()">
            <i class="fa fa-search mr-1"></i>立即查询
          </button>
        </div>
        <p class="text-xs text-gray-500 mt-1">支持6位数字基金代码或基金名称查询，如：000001 或 华夏成长混合</p>
      </div>

      <!-- 市场概览和热门基金 -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <!-- 市场概览 -->
        <div class="bg-white rounded-lg shadow-sm p-4">
          <h2 class="text-md font-semibold mb-3">市场概览</h2>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm">上证指数</span>
              <span class="text-sm font-medium text-up">+1.23%</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm">深证成指</span>
              <span class="text-sm font-medium text-up">+1.87%</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm">创业板指</span>
              <span class="text-sm font-medium text-up">+2.15%</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm">北向资金</span>
              <span class="text-sm font-medium text-up">+85.6亿</span>
            </div>
          </div>
        </div>

        <!-- 热门基金推荐 -->
        <div class="bg-white rounded-lg shadow-sm p-4">
          <h2 class="text-md font-semibold mb-3">热门基金</h2>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <div>
                <p class="text-sm font-medium">华夏成长混合</p>
                <p class="text-xs text-gray-500">000001</p>
              </div>
              <span class="text-sm font-medium text-up">+0.90%</span>
            </div>
            <div class="flex justify-between items-center">
              <div>
                <p class="text-sm font-medium">景顺长城品质投资混合A</p>
                <p class="text-xs text-gray-500">000020</p>
              </div>
              <span class="text-sm font-medium text-up">+3.55%</span>
            </div>
            <div class="flex justify-between items-center">
              <div>
                <p class="text-sm font-medium">华夏新能源车ETF联接A</p>
                <p class="text-xs text-gray-500">000030</p>
              </div>
              <span class="text-sm font-medium text-up">+4.34%</span>
            </div>
            <div class="flex justify-between items-center">
              <div>
                <p class="text-sm font-medium">嘉实半导体ETF联接A</p>
                <p class="text-xs text-gray-500">000032</p>
              </div>
              <span class="text-sm font-medium text-up">+4.41%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 最新新闻摘要 -->
      <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
        <h2 class="text-md font-semibold mb-3">最新资讯</h2>
        <div class="space-y-3">
          <div class="flex gap-3">
            <img src="https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=Central%20Bank%20monetary%20policy%20news&image_size=portrait_4_3" alt="新闻" class="w-20 h-20 object-cover rounded-lg flex-shrink-0">
            <div class="flex-1">
              <h3 class="text-sm font-medium mb-1">央行降准0.5个百分点，释放长期资金约1.2万亿元</h3>
              <p class="text-xs text-gray-500 mb-1">中国证券报 · 今天</p>
              <p class="text-xs text-gray-600 line-clamp-2">央行决定于近日下调金融机构存款准备金率0.5个百分点，此次降准预计将释放长期资金约1.2万亿元...</p>
            </div>
          </div>
          <div class="flex gap-3">
            <img src="https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=Stock%20market%20rising%20trend&image_size=portrait_4_3" alt="新闻" class="w-20 h-20 object-cover rounded-lg flex-shrink-0">
            <div class="flex-1">
              <h3 class="text-sm font-medium mb-1">A股三大指数集体上涨，创业板指表现强势</h3>
              <p class="text-xs text-gray-500 mb-1">上海证券报 · 今天</p>
              <p class="text-xs text-gray-600 line-clamp-2">今日，A股市场表现强势，三大指数集体上涨。截至收盘，上证指数涨1.23%，深证成指涨1.87%...</p>
            </div>
          </div>
        </div>
        <div class="mt-3 text-right">
          <button class="text-sm text-primary hover:underline" onclick="switchTab('news')">查看更多资讯</button>
        </div>
      </div>
    </div>

    <!-- 估值查询面板 -->
    <div id="panel-query" class="hidden fade-enter">
      <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
        <div class="flex flex-col md:flex-row gap-3">
          <input
            type="text"
            id="fund-code"
            class="input flex-1"
            placeholder="请输入基金代码或基金名称"
            onkeypress="if(event.key === 'Enter') queryFund()"
          >
          <button id="query-btn" class="btn btn-primary whitespace-nowrap" onclick="queryFund()">
            <i class="fa fa-search mr-1"></i>查询
          </button>
        </div>
        <p class="text-xs text-gray-500 mt-1">支持6位数字基金代码或基金名称查询，如：000001 或 华夏成长混合</p>
      </div>

      <!-- 快速查询按钮 -->
      <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
        <h2 class="text-sm font-semibold mb-3">快速查询</h2>
        <div class="flex flex-wrap gap-2">
          <button class="btn btn-secondary text-xs py-1 px-3" onclick="quickQueryFund('000001')">华夏成长混合</button>
          <button class="btn btn-secondary text-xs py-1 px-3" onclick="quickQueryFund('000020')">景顺长城品质投资混合A</button>
          <button class="btn btn-secondary text-xs py-1 px-3" onclick="quickQueryFund('000030')">华夏新能源车ETF联接A</button>
          <button class="btn btn-secondary text-xs py-1 px-3" onclick="quickQueryFund('000032')">嘉实半导体ETF联接A</button>
          <button class="btn btn-secondary text-xs py-1 px-3" onclick="quickQueryFund('000008')">嘉实中证500ETF联接A</button>
          <button class="btn btn-secondary text-xs py-1 px-3" onclick="quickQueryFund('000022')">华夏创业板ETF联接A</button>
        </div>
      </div>

      <!-- 查询结果 -->
      <div id="query-result" class="hidden">
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
          <div class="flex justify-between items-center mb-3">
            <h2 class="text-md font-semibold" id="fund-name"></h2>
            <span class="text-xs text-gray-500" id="fund-code-display"></span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="bg-gray-50 p-3 rounded-lg">
              <p class="text-xs text-gray-500">单位净值</p>
              <p class="text-lg font-medium" id="net-value"></p>
              <p class="text-xs text-gray-400" id="nav-date"></p>
            </div>
            <div class="bg-gray-50 p-3 rounded-lg">
              <p class="text-xs text-gray-500">实时估值</p>
              <p class="text-lg font-medium" id="estimate-value"></p>
              <p class="text-xs text-gray-400">估值时间：<span id="estimate-time"></span></p>
            </div>
            <div class="bg-gray-50 p-3 rounded-lg">
              <p class="text-xs text-gray-500">日涨跌幅</p>
              <p class="text-lg font-medium" id="day-change"></p>
              <p class="text-xs text-gray-400">估值涨幅仅供参考</p>
            </div>
          </div>

          <!-- 基金走势图 -->
          <div class="mt-6">
            <h3 class="text-sm font-semibold mb-3">基金走势图</h3>
            <div id="fund-chart" class="w-full h-56 bg-gray-50 rounded-lg p-3"></div>
          </div>

          <!-- 近30天业绩走势 -->
          <div class="mt-6">
            <h3 class="text-sm font-semibold mb-3">近30天业绩走势</h3>
            <div id="performance-chart" class="w-full h-56 bg-gray-50 rounded-lg p-3"></div>
          </div>

          <div class="mt-4 flex justify-end">
            <button class="btn btn-secondary" onclick="showAddPositionModal()">
              <i class="fa fa-plus mr-1"></i>添加到持仓
            </button>
          </div>
        </div>
      </div>

      <!-- 加载状态 -->
      <div id="loading" class="hidden bg-white rounded-lg shadow-sm p-4 mb-4 flex justify-center items-center">
        <i class="fa fa-spinner fa-spin text-primary text-lg mr-2"></i>
        <span>正在查询基金估值...</span>
      </div>

      <!-- 错误提示 -->
      <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
        <div class="flex">
          <i class="fa fa-exclamation-circle text-red-500 mt-0.5 mr-2"></i>
          <div>
            <h3 class="text-xs font-medium text-red-800">查询失败</h3>
            <p class="text-xs text-red-700 mt-1" id="error-message"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- 我的持仓面板 -->
    <div id="panel-position" class="hidden fade-enter">
      <!-- 持仓概览 -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
        <div class="bg-white rounded-lg shadow-sm p-4">
          <h2 class="text-md font-semibold mb-3">持仓概览</h2>
          <div class="grid grid-cols-3 gap-3">
            <div class="text-center">
              <p class="text-xs text-gray-500">总持仓</p>
              <p class="text-lg font-medium" id="total-positions">0</p>
            </div>
            <div class="text-center">
              <p class="text-xs text-gray-500">上涨</p>
              <p class="text-lg font-medium text-up" id="up-count">0</p>
            </div>
            <div class="text-center">
              <p class="text-xs text-gray-500">下跌</p>
              <p class="text-lg font-medium text-down" id="down-count">0</p>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-4">
          <h2 class="text-md font-semibold mb-3">收益统计</h2>
          <div class="grid grid-cols-1 gap-2">
            <div class="flex justify-between">
              <span class="text-xs text-gray-500">当日收益</span>
              <span class="font-medium" id="today-profit">¥0.00</span>
            </div>
            <div class="flex justify-between">
              <span class="text-xs text-gray-500">持有收益</span>
              <span class="font-medium" id="hold-profit">¥0.00</span>
            </div>
            <div class="flex justify-between">
              <span class="text-xs text-gray-500">整体收益率</span>
              <span class="font-medium" id="total-rate">0.00%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 操作按钮 -->
      <div class="flex flex-wrap justify-between items-center mb-3 gap-2">
        <h2 class="text-md font-semibold">持仓列表</h2>
        <div class="flex flex-wrap gap-2">
          <button class="btn btn-secondary text-sm py-1 px-3" onclick="showAddPositionModal()">
            <i class="fa fa-plus mr-1"></i>添加
          </button>
          <button class="btn btn-primary text-sm py-1 px-3" onclick="refreshAllPositions()">
            <i class="fa fa-refresh mr-1"></i>刷新
          </button>
          <button class="btn btn-danger text-sm py-1 px-3" onclick="batchDeletePositions()" id="batch-delete-btn" disabled>
            <i class="fa fa-trash mr-1"></i>批量删除
          </button>
          <button class="btn btn-primary text-sm py-1 px-3" onclick="shareApp()">
            <i class="fa fa-share-alt mr-1"></i>分享
          </button>
        </div>
      </div>

      <!-- 排序控制 -->
      <div class="bg-white rounded-lg shadow-sm p-3 mb-3">
        <div class="flex flex-wrap gap-3">
          <div class="flex items-center">
            <span class="text-xs text-gray-500 mr-1">排序：</span>
            <select id="sort-by" class="input text-xs py-1" onchange="sortPositions()">
              <option value="default">默认</option>
              <option value="dayChange">当日涨幅</option>
              <option value="todayProfit">当日收益</option>
              <option value="holdProfit">持有收益</option>
            </select>
          </div>
          <div class="flex items-center">
            <span class="text-xs text-gray-500 mr-1">顺序：</span>
            <select id="sort-order" class="input text-xs py-1" onchange="sortPositions()">
              <option value="desc">降序</option>
              <option value="asc">升序</option>
            </select>
          </div>
        </div>
      </div>

      <!-- 持仓列表 -->
      <div id="position-list" class="bg-white rounded-lg shadow-sm overflow-hidden mb-4">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                <input type="checkbox" id="select-all-checkbox" onchange="selectAllPositions(this.checked)">
              </th>
              <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">基金名称</th>
              <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">代码</th>
              <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">份额</th>
              <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">成本</th>
              <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">交易时间</th>
              <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">持有日</th>
              <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">估值</th>
              <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日涨跌幅</th>
              <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">当日收益</th>
              <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">持有收益</th>
              <th scope="col" class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200" id="position-table-body">
            <!-- 持仓数据将通过JS动态添加 -->
          </tbody>
          <tbody class="bg-white divide-y divide-gray-200">
            <!-- 空状态 -->
            <tr id="empty-position">
              <td colspan="12" class="px-4 py-8 text-center text-gray-500">
                <i class="fa fa-inbox text-2xl mb-2"></i>
                <p>暂无持仓数据</p>
                <p class="text-xs mt-1">点击"添加"按钮开始管理你的基金</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 涨跌榜面板 -->
    <div id="panel-ranking" class="hidden fade-enter">
      <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">市场涨跌榜</h2>
          <button class="btn btn-primary" onclick="refreshRanking()">
            <i class="fa fa-refresh mr-2"></i>刷新榜单
          </button>
        </div>
        <p class="text-sm text-gray-500 mb-4">展示市场上表现最好和最差的基金，数据仅供参考</p>
      </div>

      <!-- 涨跌榜内容 -->
      <div class="mb-6">
        <div class="flex flex-col md:flex-row justify-center gap-4">
          <!-- 上涨榜 -->
          <div class="bg-white rounded-lg shadow-sm overflow-hidden flex-1 min-w-[300px] max-w-[500px]">
            <div class="bg-up/10 px-6 py-3 border-b border-up/20">
              <h3 class="text-md font-medium text-up flex items-center">
                <i class="fa fa-arrow-up mr-2"></i>上涨榜
              </h3>
            </div>
            <div class="p-4">
              <div class="overflow-x-auto">
                <table class="min-w-full">
                  <thead class="text-xs font-medium text-gray-500 uppercase tracking-wider">
                    <tr>
                      <th class="px-3 py-2 text-left w-[50px]">排名</th>
                      <th class="px-3 py-2 text-left">基金名称</th>
                      <th class="px-3 py-2 text-left w-[70px]">代码</th>
                      <th class="px-3 py-2 text-left w-[90px]">日涨跌幅</th>
                      <th class="px-3 py-2 text-left w-[80px]">估值</th>
                    </tr>
                  </thead>
                  <tbody id="up-ranking-body" class="divide-y divide-gray-200">
                    <!-- 上涨榜数据将通过JS动态添加 -->
                    <tr>
                      <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                        <i class="fa fa-refresh fa-spin text-primary text-xl mb-2"></i>
                        <p>点击刷新按钮获取涨跌榜数据</p>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- 下跌榜 -->
          <div class="bg-white rounded-lg shadow-sm overflow-hidden flex-1 min-w-[300px] max-w-[500px]">
            <div class="bg-down/10 px-6 py-3 border-b border-down/20">
              <h3 class="text-md font-medium text-down flex items-center">
                <i class="fa fa-arrow-down mr-2"></i>下跌榜
              </h3>
            </div>
            <div class="p-4">
              <div class="overflow-x-auto">
                <table class="min-w-full">
                  <thead class="text-xs font-medium text-gray-500 uppercase tracking-wider">
                    <tr>
                      <th class="px-3 py-2 text-left w-[50px]">排名</th>
                      <th class="px-3 py-2 text-left">基金名称</th>
                      <th class="px-3 py-2 text-left w-[70px]">代码</th>
                      <th class="px-3 py-2 text-left w-[90px]">日涨跌幅</th>
                      <th class="px-3 py-2 text-left w-[80px]">估值</th>
                    </tr>
                  </thead>
                  <tbody id="down-ranking-body" class="divide-y divide-gray-200">
                    <!-- 下跌榜数据将通过JS动态添加 -->
                    <tr>
                      <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                        <i class="fa fa-refresh fa-spin text-primary text-xl mb-2"></i>
                        <p>点击刷新按钮获取涨跌榜数据</p>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 新闻资讯面板 -->
    <div id="panel-news" class="hidden fade-enter">
      <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">投资板块新闻资讯</h2>
          <button class="btn btn-primary" onclick="refreshNews()">
            <i class="fa fa-refresh mr-2"></i>刷新新闻
          </button>
        </div>
        <p class="text-sm text-gray-500 mb-4">实时抓取投资相关新闻，助您把握市场动态</p>
      </div>

      <!-- 新闻列表 -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div id="news-list" class="bg-white rounded-lg shadow-sm overflow-hidden h-[500px] overflow-y-auto">
          <div class="p-4">
            <div id="news-content" class="space-y-4">
              <!-- 新闻数据将通过JS动态添加 -->
              <div class="text-center py-8 text-gray-500">
                <i class="fa fa-newspaper-o text-3xl mb-2"></i>
                <p>点击刷新按钮获取新闻资讯</p>
              </div>
            </div>
          </div>
        </div>

        <!-- 新闻详情 -->
        <div id="news-detail" class="bg-white rounded-lg shadow-sm overflow-hidden h-[500px] overflow-y-auto">
          <div class="p-4">
            <h3 class="text-lg font-semibold mb-2" id="news-title">新闻详情</h3>
            <div class="text-sm text-gray-500 mb-4" id="news-meta"></div>
            <div class="prose max-w-none" id="news-body">
              <p class="text-gray-500">点击左侧新闻标题查看详情</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 底部信息 -->
  <footer class="bg-white border-t border-gray-200 py-6">
    <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
      <p>基金估值仅供参考，实际净值以基金公司公告为准</p>
      <p class="mt-1">© 2026 估值宝</p>
    </div>
  </footer>

  <!-- 添加/编辑持仓弹窗 -->
  <div id="position-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all duration-300">
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium" id="modal-title">添加持仓</h3>
      </div>
      <div class="px-6 py-4">
        <form id="position-form">
          <input type="hidden" id="edit-index">
          <div class="mb-4">
            <label for="modal-fund-code" class="block text-sm font-medium text-gray-700 mb-1">基金代码</label>
            <input
              type="text"
              id="modal-fund-code"
              class="input w-full"
              placeholder="请输入6位基金代码"
              maxlength="6"
              oninput="this.value = this.value.replace(/[^0-9]/g, ''); if(this.value.length === 6) { getFundNameByCode(this.value); }"
            >
            <p class="text-sm text-gray-500 mt-1" id="modal-fund-name-display"></p>
          </div>
          <div class="mb-4">
            <label for="modal-shares" class="block text-sm font-medium text-gray-700 mb-1">持仓份额</label>
            <input
              type="number"
              id="modal-shares"
              class="input w-full"
              placeholder="请输入持仓份额"
              min="0.01"
              step="0.01"
            >
          </div>
          <div class="mb-4">
            <label for="modal-cost" class="block text-sm font-medium text-gray-700 mb-1">成本价</label>
            <input
              type="number"
              id="modal-cost"
              class="input w-full"
              placeholder="请输入成本价"
              min="0.01"
              step="0.01"
            >
          </div>
          <div class="mb-4">
            <label for="modal-trade-date" class="block text-sm font-medium text-gray-700 mb-1">交易时间</label>
            <input
              type="date"
              id="modal-trade-date"
              class="input w-full"
              value=""
            >
          </div>
        </form>
      </div>
      <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-2">
        <button class="btn btn-secondary" onclick="closePositionModal()">取消</button>
        <button class="btn btn-primary" onclick="savePosition()">保存</button>
      </div>
    </div>
  </div>

  <!-- Toast 提示 -->
  <div id="toast" class="fixed top-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-md shadow-lg transform transition-all duration-300 translate-x-full opacity-0">
    <span id="toast-message"></span>
  </div>

  <script>
    // 全局变量
    let currentFundData = null;
    let positionList = [];
    let originalPositionList = [];
    let historyStack = [];

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化主题
      initTheme();
      
      // 确保positionList有数据
      try {
        positionList = JSON.parse(localStorage.getItem('positionList')) || [];
        originalPositionList = JSON.parse(localStorage.getItem('originalPositionList')) || [];
      } catch (error) {
        // 如果localStorage中的数据有问题，重置为示例数据
        positionList = [
          {
            code: "000001",
            shares: 1000,
            cost: 1.2345,
            tradeDate: "2026-01-01",
            name: "华夏成长混合",
            estimate: 1.2456,
            dayChange: 0.90
          },
          {
            code: "000005",
            shares: 2000,
            cost: 1.0567,
            tradeDate: "2026-01-02",
            name: "嘉实增强信用定期债券",
            estimate: 1.0589,
            dayChange: 0.21
          }
        ];
        localStorage.setItem('positionList', JSON.stringify(positionList));
        localStorage.setItem('originalPositionList', JSON.stringify(positionList));
      }
      
      // 如果positionList仍然为空，添加示例数据
      if (!Array.isArray(positionList) || positionList.length === 0) {
        positionList = [
          {
            code: "000001",
            shares: 1000,
            cost: 1.2345,
            tradeDate: "2026-01-01",
            name: "华夏成长混合",
            estimate: 1.2456,
            dayChange: 0.90
          },
          {
            code: "000005",
            shares: 2000,
            cost: 1.0567,
            tradeDate: "2026-01-02",
            name: "嘉实增强信用定期债券",
            estimate: 1.0589,
            dayChange: 0.21
          }
        ];
        localStorage.setItem('positionList', JSON.stringify(positionList));
        localStorage.setItem('originalPositionList', JSON.stringify(positionList));
      }
      
      // 确保每个持仓项都有必要的属性
      positionList.forEach(position => {
        if (position) {
          position.name = position.name || `基金${position.code}`;
          position.estimate = position.estimate || position.cost;
          position.dayChange = position.dayChange || 0;
        }
      });
      
      // 渲染持仓列表
      renderPositions();
    });

    // 切换选项卡
    function switchTab(tab, fromHistory = false) {
      // 获取当前激活的选项卡
      let currentTab = '';
      const tabs = ['home', 'query', 'position', 'ranking', 'news'];
      tabs.forEach(t => {
        if (document.getElementById(`tab-${t}`).classList.contains('tab-active')) {
          currentTab = t;
        }
      });
      
      // 记录历史记录（除非是从历史记录返回）
      if (!fromHistory && currentTab) {
        historyStack.push(currentTab);
        // 限制历史记录长度
        if (historyStack.length > 10) {
          historyStack.shift();
        }
      }
      
      console.log('历史记录：', historyStack);
      
      // 重置所有选项卡和面板
      tabs.forEach(t => {
        document.getElementById(`tab-${t}`).classList.remove('tab-active');
        document.getElementById(`tab-${t}`).classList.add('text-gray-500', 'hover:text-gray-700');
        document.getElementById(`panel-${t}`).classList.add('hidden');
        document.getElementById(`panel-${t}`).classList.remove('fade-enter-active');
      });

      // 激活选中的选项卡和面板
      document.getElementById(`tab-${tab}`).classList.add('tab-active');
      document.getElementById(`tab-${tab}`).classList.remove('text-gray-500', 'hover:text-gray-700');
      document.getElementById(`panel-${tab}`).classList.remove('hidden');
      document.getElementById(`panel-${tab}`).classList.add('fade-enter-active');

      // 特殊处理
      if (tab === 'position') {
        console.log('切换到持仓选项卡，调用renderPositions');
        renderPositions();
        // 停止其他自动刷新
        stopRankingAutoRefresh();
        stopNewsAutoRefresh();
      } else if (tab === 'news') {
        console.log('切换到新闻资讯选项卡，启动自动刷新');
        refreshNews();
        startNewsAutoRefresh();
        // 停止其他自动刷新
        stopRankingAutoRefresh();
      } else if (tab === 'ranking') {
        console.log('切换到涨跌榜选项卡，启动自动刷新');
        refreshRanking();
        startRankingAutoRefresh();
        // 停止其他自动刷新
        stopNewsAutoRefresh();
      } else {
        // 切换到首页或查询选项卡时停止所有自动刷新
        stopRankingAutoRefresh();
        stopNewsAutoRefresh();
      }
      
      // 更新返回按钮状态
      updateBackButton();
    }
    
    // 首页查询基金
    function homeQueryFund() {
      const input = document.getElementById('home-fund-code').value.trim();
      
      // 校验输入
      if (!input) {
        showToast('请输入基金代码或基金名称');
        return;
      }
      
      // 切换到估值查询面板
      switchTab('query');
      
      // 填充基金代码到输入框
      document.getElementById('fund-code').value = input;
      
      // 触发查询操作
      queryFund();
    }

    // 基金名称和代码映射表
    const fundNameMap = {
      '华夏成长混合': '000001',
      '嘉实增强信用定期债券': '000005',
      '华夏纯债券A': '000015',
      '华夏纯债券C': '000016',
      '财通可持续混合': '000017',
      '景顺长城品质投资混合A': '000020',
      '华夏优势增长混合': '000021',
      '嘉实中证500ETF联接A': '000008',
      '华夏亚债中国指数A': '000010',
      '华夏亚债中国指数C': '000011',
      '华夏债券AB': '000012',
      '华夏债券C': '000013',
      '华夏货币A': '000014',
      '嘉实货币A': '000034',
      '嘉实货币B': '000035',
      '华夏回报混合A': '002001',
      '华夏回报混合B': '002002',
      '华夏红利混合': '002011',
      '嘉实成长混合A': '070001',
      '嘉实增长混合': '070002',
      '嘉实稳健混合': '070003',
      '嘉实债券': '070005'
    };

    // 模拟基金数据（备用）
    const mockFundData = {
      '000001': {
        name: '华夏成长混合',
        fundcode: '000001',
        dwjz: '1.2345',
        gsz: '1.2456',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 0.90
      },
      '000005': {
        name: '嘉实增强信用定期债券',
        fundcode: '000005',
        dwjz: '1.0567',
        gsz: '1.0589',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 0.21
      },
      '000015': {
        name: '华夏纯债券A',
        fundcode: '000015',
        dwjz: '1.1234',
        gsz: '1.1245',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 0.10
      },
      '000016': {
        name: '华夏纯债券C',
        fundcode: '000016',
        dwjz: '1.1123',
        gsz: '1.1134',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 0.10
      },
      '000017': {
        name: '财通可持续混合',
        fundcode: '000017',
        dwjz: '0.9876',
        gsz: '0.9654',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: -2.25
      },
      '000020': {
        name: '景顺长城品质投资混合A',
        fundcode: '000020',
        dwjz: '1.5678',
        gsz: '1.6234',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 3.55
      },
      '000021': {
        name: '华夏优势增长混合',
        fundcode: '000021',
        dwjz: '2.3456',
        gsz: '2.4123',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 2.85
      },
      '000008': {
        name: '嘉实中证500ETF联接A',
        fundcode: '000008',
        dwjz: '1.1234',
        gsz: '1.1456',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 1.98
      },
      '000010': {
        name: '华夏亚债中国指数A',
        fundcode: '000010',
        dwjz: '1.0876',
        gsz: '1.0934',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 0.53
      },
      '000011': {
        name: '华夏亚债中国指数C',
        fundcode: '000011',
        dwjz: '1.0765',
        gsz: '1.0812',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 0.44
      },
      '000012': {
        name: '华夏债券AB',
        fundcode: '000012',
        dwjz: '1.1345',
        gsz: '1.1378',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 0.29
      },
      '000013': {
        name: '华夏债券C',
        fundcode: '000013',
        dwjz: '1.1234',
        gsz: '1.1256',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 0.19
      },
      '000014': {
        name: '华夏货币A',
        fundcode: '000014',
        dwjz: '1.0000',
        gsz: '1.0001',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 0.01
      },
      '000018': {
        name: '嘉实元和混合A',
        fundcode: '000018',
        dwjz: '1.4567',
        gsz: '1.4234',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: -2.30
      },
      '000019': {
        name: '嘉实元和混合C',
        fundcode: '000019',
        dwjz: '1.4456',
        gsz: '1.4123',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: -2.31
      },
      '000022': {
        name: '华夏创业板ETF联接A',
        fundcode: '000022',
        dwjz: '1.8765',
        gsz: '1.9456',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 3.68
      },
      '000023': {
        name: '华夏创业板ETF联接C',
        fundcode: '000023',
        dwjz: '1.8654',
        gsz: '1.9345',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 3.70
      },
      '000024': {
        name: '嘉实沪深300ETF联接A',
        fundcode: '000024',
        dwjz: '1.2345',
        gsz: '1.2678',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 2.70
      },
      '000025': {
        name: '嘉实沪深300ETF联接C',
        fundcode: '000025',
        dwjz: '1.2234',
        gsz: '1.2567',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 2.72
      },
      '000026': {
        name: '华夏上证50ETF联接A',
        fundcode: '000026',
        dwjz: '1.3456',
        gsz: '1.3890',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 3.23
      },
      '000027': {
        name: '华夏上证50ETF联接C',
        fundcode: '000027',
        dwjz: '1.3345',
        gsz: '1.3789',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 3.33
      },
      '000028': {
        name: '嘉实中证1000ETF联接A',
        fundcode: '000028',
        dwjz: '1.0987',
        gsz: '1.1345',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 3.25
      },
      '000029': {
        name: '嘉实中证1000ETF联接C',
        fundcode: '000029',
        dwjz: '1.0876',
        gsz: '1.1234',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 3.29
      },
      '000030': {
        name: '华夏新能源车ETF联接A',
        fundcode: '000030',
        dwjz: '2.1234',
        gsz: '2.2156',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 4.34
      },
      '000031': {
        name: '华夏新能源车ETF联接C',
        fundcode: '000031',
        dwjz: '2.1123',
        gsz: '2.2045',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 4.37
      },
      '000032': {
        name: '嘉实半导体ETF联接A',
        fundcode: '000032',
        dwjz: '1.7654',
        gsz: '1.8432',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 4.41
      },
      '000033': {
        name: '嘉实半导体ETF联接C',
        fundcode: '000033',
        dwjz: '1.7543',
        gsz: '1.8321',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: 4.44
      },
      '000034': {
        name: '华夏医药ETF联接A',
        fundcode: '000034',
        dwjz: '1.4321',
        gsz: '1.4056',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: -1.85
      },
      '000035': {
        name: '华夏医药ETF联接C',
        fundcode: '000035',
        dwjz: '1.4210',
        gsz: '1.3945',
        gztime: '2026-02-04 15:00',
        jzrq: '2026-02-03',
        dayChange: -1.87
      }
    };

    // 查询基金估值
    function queryFund() {
      const input = document.getElementById('fund-code').value.trim();
      
      // 校验输入
      if (!input) {
        showError('请输入基金代码或基金名称');
        return;
      }

      // 确定基金代码
      let fundCode;
      if (/^\d{6}$/.test(input)) {
        // 输入是6位数字，直接作为基金代码
        fundCode = input;
      } else {
        // 输入是基金名称，查找对应的代码
        fundCode = findFundCodeByName(input);
        if (!fundCode) {
          showError('未找到对应的基金，请检查输入是否正确');
          return;
        }
      }

      // 显示加载状态
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('query-result').classList.add('hidden');
      document.getElementById('error').classList.add('hidden');

      // 尝试使用模拟数据（备用方案）
      if (mockFundData[fundCode]) {
        const fundData = mockFundData[fundCode];
        // 保存当前基金数据
        currentFundData = fundData;
        // 显示结果
        showQueryResult(fundData);
        document.getElementById('loading').classList.add('hidden');
        showToast('使用模拟数据展示');
        return;
      }

      // 调用基金估值接口（使用 CORS 代理）
      const apiUrl = `http://fundgz.1234567.com.cn/js/${fundCode}.js`;
      const proxyUrl = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(apiUrl)}`;
      
      fetch(proxyUrl, {
        method: 'GET',
        cache: 'no-cache'
      })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.text();
        })
        .then(data => {
          try {
            // 解析返回数据
            const jsonStr = data.substring(data.indexOf('{'), data.lastIndexOf('}') + 1);
            const fundData = JSON.parse(jsonStr);
            
            // 保存当前基金数据
            currentFundData = fundData;
            
            // 显示结果
            showQueryResult(fundData);
          } catch (error) {
            showError('基金代码错误或查询失败，请检查后重试');
          }
        })
        .catch(error => {
          console.error('Fetch error:', error);
          showError('网络错误，请稍后重试，可能是基金接口或网络连接问题');
        })
        .finally(() => {
          document.getElementById('loading').classList.add('hidden');
        });
    }

    // 根据基金名称查找代码（支持模糊匹配）
    function findFundCodeByName(name) {
      // 首先尝试精确匹配
      if (fundNameMap[name]) {
        return fundNameMap[name];
      }

      // 然后尝试模糊匹配
      for (const [fundName, code] of Object.entries(fundNameMap)) {
        if (fundName.includes(name)) {
          return code;
        }
      }

      // 没有找到匹配的基金
      return null;
    }

    // 显示查询结果
    function showQueryResult(fundData) {
      document.getElementById('fund-name').textContent = fundData.name;
      document.getElementById('fund-code-display').textContent = fundData.fundcode;
      document.getElementById('net-value').textContent = fundData.jzrq + '：' + fundData.dwjz;
      document.getElementById('estimate-value').textContent = fundData.gsz;
      document.getElementById('estimate-time').textContent = fundData.gztime;
      
      // 计算涨跌幅
      const dayChange = ((fundData.gsz - fundData.dwjz) / fundData.dwjz * 100).toFixed(2);
      const dayChangeElement = document.getElementById('day-change');
      dayChangeElement.textContent = dayChange + '%';
      
      // 设置涨跌颜色
      if (parseFloat(dayChange) > 0) {
        dayChangeElement.className = 'text-xl font-medium text-up';
      } else if (parseFloat(dayChange) < 0) {
        dayChangeElement.className = 'text-xl font-medium text-down';
      } else {
        dayChangeElement.className = 'text-xl font-medium text-flat';
      }
      
      // 显示结果面板
      document.getElementById('query-result').classList.remove('hidden');
      document.getElementById('error').classList.add('hidden');
      
      // 初始化基金走势图
      initFundChart(fundData);
      
      // 初始化近30天业绩走势图
      initPerformanceChart(fundData);
    }
    
    // 初始化基金走势图
    function initFundChart(fundData) {
      const fundChart = echarts.init(document.getElementById('fund-chart'));
      
      // 生成模拟数据（近30天）
      const dates = [];
      const values = [];
      const baseValue = parseFloat(fundData.dwjz);
      
      for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        dates.push(date.getMonth() + 1 + '/' + date.getDate());
        
        // 生成随机波动数据
        const randomChange = (Math.random() * 0.6 - 0.3);
        const value = (baseValue + randomChange).toFixed(4);
        values.push(parseFloat(value));
      }
      
      // 计算沪深300模拟数据
      const hs300Values = values.map(v => v * (1 + (Math.random() * 0.2 - 0.1)));
      
      const option = {
        tooltip: {
          trigger: 'axis',
          formatter: function(params) {
            let result = params[0].name + '<br/>';
            params.forEach(param => {
              result += param.marker + param.seriesName + ': ' + param.value.toFixed(4) + '<br/>';
            });
            return result;
          }
        },
        legend: {
          data: [fundData.name, '沪深300'],
          top: 0
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          boundaryGap: false,
          data: dates,
          axisLabel: {
            rotate: 45
          }
        },
        yAxis: {
          type: 'value',
          axisLabel: {
            formatter: '¥{value}'
          }
        },
        series: [
          {
            name: fundData.name,
            type: 'line',
            data: values,
            smooth: true,
            lineStyle: {
              color: '#3b82f6',
              width: 2
            },
            areaStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                {
                  offset: 0,
                  color: 'rgba(59, 130, 246, 0.3)'
                },
                {
                  offset: 1,
                  color: 'rgba(59, 130, 246, 0.1)'
                }
              ])
            }
          },
          {
            name: '沪深300',
            type: 'line',
            data: hs300Values,
            smooth: true,
            lineStyle: {
              color: '#f59e0b',
              width: 2
            },
            areaStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                {
                  offset: 0,
                  color: 'rgba(245, 158, 11, 0.3)'
                },
                {
                  offset: 1,
                  color: 'rgba(245, 158, 11, 0.1)'
                }
              ])
            }
          }
        ]
      };
      
      fundChart.setOption(option);
      
      // 响应式调整
      window.addEventListener('resize', function() {
        fundChart.resize();
      });
    }
    
    // 初始化近30天业绩走势图
    function initPerformanceChart(fundData) {
      const performanceChart = echarts.init(document.getElementById('performance-chart'));
      
      // 生成模拟数据（近30天每日涨跌幅）
      const dates = [];
      const changes = [];
      
      for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        dates.push(date.getMonth() + 1 + '/' + date.getDate());
        
        // 生成随机涨跌幅
        const change = (Math.random() * 4 - 2).toFixed(2);
        changes.push(parseFloat(change));
      }
      
      // 计算累计收益
      const cumulative = [];
      let sum = 0;
      changes.forEach(change => {
        sum += change;
        cumulative.push(sum);
      });
      
      const option = {
        tooltip: {
          trigger: 'axis',
          formatter: function(params) {
            let result = params[0].name + '<br/>';
            params.forEach(param => {
              result += param.marker + param.seriesName + ': ' + param.value.toFixed(2) + '%<br/>';
            });
            return result;
          }
        },
        legend: {
          data: ['日涨幅', '累计收益'],
          top: 0
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          boundaryGap: false,
          data: dates,
          axisLabel: {
            rotate: 45
          }
        },
        yAxis: {
          type: 'value',
          axisLabel: {
            formatter: '{value}%'
          }
        },
        series: [
          {
            name: '日涨幅',
            type: 'bar',
            data: changes,
            itemStyle: {
              color: function(params) {
                return params.value >= 0 ? '#ef4444' : '#10b981';
              }
            }
          },
          {
            name: '累计收益',
            type: 'line',
            data: cumulative,
            smooth: true,
            lineStyle: {
              color: '#3b82f6',
              width: 2
            },
            itemStyle: {
              color: '#3b82f6'
            }
          }
        ]
      };
      
      performanceChart.setOption(option);
      
      // 响应式调整
      window.addEventListener('resize', function() {
        performanceChart.resize();
      });
    }

    // 显示错误信息
    function showError(message) {
      document.getElementById('error-message').textContent = message;
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('query-result').classList.add('hidden');
    }

    // 显示添加持仓弹窗
    function showAddPositionModal() {
      document.getElementById('modal-title').textContent = '添加持仓';
      document.getElementById('edit-index').value = '';
      document.getElementById('modal-fund-code').value = currentFundData ? currentFundData.fundcode : '';
      document.getElementById('modal-shares').value = '';
      document.getElementById('modal-cost').value = '';
      document.getElementById('modal-trade-date').value = '';
      document.getElementById('modal-fund-name-display').textContent = '';
      document.getElementById('position-modal').classList.remove('hidden');
    }

    // 显示编辑持仓弹窗
    function showEditPositionModal(index) {
      const position = positionList[index];
      // 确保position对象存在
      if (!position) {
        showToast('持仓数据无效');
        return;
      }
      document.getElementById('modal-title').textContent = '编辑持仓';
      document.getElementById('edit-index').value = index;
      document.getElementById('modal-fund-code').value = position.code || '';
      document.getElementById('modal-shares').value = position.shares || '';
      document.getElementById('modal-cost').value = position.cost || '';
      document.getElementById('modal-trade-date').value = position.tradeDate || '';
      // 如果有基金代码，显示基金名称
      if (position.code) {
        getFundNameByCode(position.code);
      } else {
        document.getElementById('modal-fund-name-display').textContent = '';
      }
      document.getElementById('position-modal').classList.remove('hidden');
    }

    // 关闭弹窗
    function closePositionModal() {
      document.getElementById('position-modal').classList.add('hidden');
    }

    // 保存持仓
    function savePosition() {
      const fundCode = document.getElementById('modal-fund-code').value.trim();
      const shares = parseFloat(document.getElementById('modal-shares').value);
      const cost = parseFloat(document.getElementById('modal-cost').value);
      const editIndexStr = document.getElementById('edit-index').value;
      const editIndex = editIndexStr !== '' ? parseInt(editIndexStr, 10) : -1;

      // 校验输入
      if (!fundCode || fundCode.length !== 6) {
        showToast('请输入6位数字基金代码');
        return;
      }

      if (!shares || shares <= 0) {
        showToast('请输入有效的持仓份额');
        return;
      }

      if (!cost || cost <= 0) {
        showToast('请输入有效的成本价');
        return;
      }

      // 检查是否重复添加
      if (editIndex === -1) {
        const isDuplicate = positionList.some(pos => pos.code === fundCode);
        if (isDuplicate) {
          showToast('该基金已在持仓列表中');
          return;
        }
      }

      // 获取交易时间
      const tradeDate = document.getElementById('modal-trade-date').value;

      // 构建持仓对象
      const position = {
        code: fundCode,
        shares: shares,
        cost: cost,
        tradeDate: tradeDate
      };

      // 保存到持仓列表
      if (editIndex !== -1) {
        positionList[editIndex] = position;
        showToast('持仓修改成功');
      } else {
        positionList.push(position);
        showToast('持仓添加成功');
      }

      // 保存到本地存储
      localStorage.setItem('positionList', JSON.stringify(positionList));
      localStorage.setItem('originalPositionList', JSON.stringify(positionList));

      // 关闭弹窗并刷新持仓列表
      closePositionModal();
      renderPositions();
    }

    // 删除持仓
    function deletePosition(index) {
      if (confirm('确定要删除该持仓吗？')) {
        positionList.splice(index, 1);
        localStorage.setItem('positionList', JSON.stringify(positionList));
        localStorage.setItem('originalPositionList', JSON.stringify(positionList));
        showToast('持仓删除成功');
        renderPositions();
      }
    }

    // 渲染持仓列表
    function renderPositions() {
      const tableBody = document.getElementById('position-table-body');
      const emptyPosition = document.getElementById('empty-position');
      const emptyPositionTbody = emptyPosition ? emptyPosition.parentElement : null;
      
      // 确保元素存在
      if (!tableBody || !emptyPosition || !emptyPositionTbody) {
        console.error('表格元素不存在');
        return;
      }
      
      // 清空表格
      tableBody.innerHTML = '';
      
      // 确保positionList存在且为数组
      if (!Array.isArray(positionList)) {
        positionList = [];
      }
      
      // 显示空状态
      if (positionList.length === 0) {
        console.log('显示空状态');
        emptyPositionTbody.classList.remove('hidden');
        updatePositionSummary([]);
        return;
      }

      // 隐藏空状态
      emptyPositionTbody.classList.add('hidden');
      console.log('隐藏空状态，开始渲染持仓项');
      
      // 调试信息
      console.log('渲染持仓列表，数据长度：', positionList.length);
      console.log('持仓数据：', positionList);

      // 渲染持仓列表
      try {
        positionList.forEach((position, index) => {
          console.log('处理持仓项', index, position);
          
          // 确保position对象存在
          if (!position) {
            console.warn('持仓项为空', index);
            return;
          }
          
          const row = document.createElement('tr');
          row.className = 'card-hover';
          
          // 计算收益
          const estimate = position.estimate || position.cost || 0;
          const dayChange = position.dayChange || 0;
          const shares = position.shares || 0;
          const cost = position.cost || 0;
          const todayProfit = shares * (estimate - cost) * (dayChange / 100);
          const holdProfit = shares * (estimate - cost);
          
          // 设置涨跌颜色
          let dayChangeClass = 'text-flat';
          if (dayChange > 0) dayChangeClass = 'text-up';
          else if (dayChange < 0) dayChangeClass = 'text-down';

          let todayProfitClass = 'text-flat';
          if (todayProfit > 0) todayProfitClass = 'text-up';
          else if (todayProfit < 0) todayProfitClass = 'text-down';

          let holdProfitClass = 'text-flat';
          if (holdProfit > 0) holdProfitClass = 'text-up';
          else if (holdProfit < 0) holdProfitClass = 'text-down';

          // 计算持有天数
          function calculateHoldDays(tradeDate) {
            if (!tradeDate) return '-';
            const today = new Date();
            const trade = new Date(tradeDate);
            const diffTime = Math.abs(today - trade);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
          }

          const holdDays = calculateHoldDays(position.tradeDate);

          // 创建表格行内容
          const rowContent = `
            <td class="px-6 py-4 whitespace-nowrap">
              <input type="checkbox" class="position-checkbox" data-index="${index}" onchange="updateBatchDeleteButton()">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium">
                <a href="javascript:void(0)" class="text-primary hover:text-primary/80" onclick="viewFundDetail('${position.code || ''}')">
                  ${position.name || `基金${position.code || '未知'}`}
                </a>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-500">${position.code || '-'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm">${shares.toFixed(2)}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm">¥${cost.toFixed(4)}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm">${position.tradeDate || '-'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm">${holdDays}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm">¥${estimate.toFixed(4)}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm ${dayChangeClass}">${dayChange.toFixed(2)}%</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm ${todayProfitClass}">¥${todayProfit.toFixed(2)}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm ${holdProfitClass}">¥${holdProfit.toFixed(2)}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <button class="text-primary hover:text-primary/80 mr-3" onclick="showEditPositionModal(${index})" title="编辑">
                <i class="fa fa-pencil"></i> 编辑
              </button>
              <button class="text-danger hover:text-danger/80" onclick="deletePosition(${index})" title="删除">
                <i class="fa fa-trash"></i> 删除
              </button>
            </td>
          `;
          
          row.innerHTML = rowContent;
          tableBody.appendChild(row);
          console.log('添加持仓项到表格', index);
        });
      } catch (error) {
        console.error('渲染持仓列表时出错', error);
        // 显示错误状态
        emptyPositionTbody.classList.remove('hidden');
        emptyPosition.innerHTML = `
          <td colspan="12" class="px-6 py-12 text-center text-gray-500">
            <i class="fa fa-exclamation-circle text-3xl mb-2"></i>
            <p>渲染持仓列表时出错</p>
            <p class="text-sm mt-1">${error.message}</p>
          </td>
        `;
        return;
      }

      // 更新持仓汇总
      updatePositionSummary(positionList);
      console.log('持仓列表渲染完成');
    }

    // 刷新所有持仓估值
    function refreshAllPositions() {
      if (positionList.length === 0) {
        showToast('暂无持仓数据');
        return;
      }

      // 显示加载状态
      showToast('正在刷新估值...');

      // 使用模拟数据（备用方案）
      positionList.forEach(position => {
        if (mockFundData[position.code]) {
          const fundData = mockFundData[position.code];
          position.name = fundData.name;
          position.estimate = parseFloat(fundData.gsz);
          position.dayChange = parseFloat(((fundData.gsz - fundData.dwjz) / fundData.dwjz * 100).toFixed(2));
        } else {
          // 为没有模拟数据的基金生成随机数据
          position.name = position.name || `基金${position.code}`;
          position.estimate = parseFloat((Math.random() * 0.5 + 0.8).toFixed(4));
          position.dayChange = parseFloat((Math.random() * 4 - 1).toFixed(2));
        }
      });

      // 保存到本地存储
      localStorage.setItem('positionList', JSON.stringify(positionList));

      // 刷新列表
      renderPositions();
      showToast('使用模拟数据刷新估值');
      return;

      // 以下是原有的网络请求代码，作为备用
      /*
      // 并行请求所有基金估值
      const promises = positionList.map(position => {
        const apiUrl = `http://fundgz.1234567.com.cn/js/${position.code}.js`;
        const proxyUrl = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(apiUrl)}`;
        return fetch(proxyUrl, {
          method: 'GET',
          cache: 'no-cache'
        })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
          })
          .then(data => {
            try {
              const jsonStr = data.substring(data.indexOf('{'), data.lastIndexOf('}') + 1);
              return JSON.parse(jsonStr);
            } catch (error) {
              return null;
            }
          })
          .catch(error => {
            return null;
          });
      });

      // 处理所有请求结果
      Promise.all(promises)
        .then(results => {
          results.forEach((fundData, index) => {
            if (fundData) {
              positionList[index].name = fundData.name;
              positionList[index].estimate = parseFloat(fundData.gsz);
              positionList[index].dayChange = parseFloat(((fundData.gsz - fundData.dwjz) / fundData.dwjz * 100).toFixed(2));
            }
          });

          // 保存到本地存储
          localStorage.setItem('positionList', JSON.stringify(positionList));

          // 刷新列表
          renderPositions();
          showToast('估值刷新完成');
        });
      */
    }

    // 更新持仓汇总
    function updatePositionSummary(positions) {
      let totalPositions = positions.length;
      let upCount = 0;
      let downCount = 0;
      let todayProfit = 0;
      let holdProfit = 0;
      let totalCost = 0;

      positions.forEach(position => {
        if (!position) return;
        
        if (position.dayChange > 0) upCount++;
        else if (position.dayChange < 0) downCount++;

        const estimate = position.estimate || position.cost || 0;
        const dayChange = position.dayChange || 0;
        const shares = position.shares || 0;
        const cost = position.cost || 0;
        
        todayProfit += shares * (estimate - cost) * (dayChange / 100);
        holdProfit += shares * (estimate - cost);
        totalCost += shares * cost;
      });

      const totalRate = totalCost > 0 ? (holdProfit / totalCost * 100) : 0;

      // 更新汇总数据
      document.getElementById('total-positions').textContent = totalPositions;
      document.getElementById('up-count').textContent = upCount;
      document.getElementById('down-count').textContent = downCount;
      document.getElementById('today-profit').textContent = `¥${todayProfit.toFixed(2)}`;
      document.getElementById('hold-profit').textContent = `¥${holdProfit.toFixed(2)}`;
      document.getElementById('total-rate').textContent = `${totalRate.toFixed(2)}%`;

      // 设置收益颜色
      const todayProfitElement = document.getElementById('today-profit');
      const holdProfitElement = document.getElementById('hold-profit');
      const totalRateElement = document.getElementById('total-rate');

      if (todayProfit > 0) todayProfitElement.className = 'font-medium text-up';
      else if (todayProfit < 0) todayProfitElement.className = 'font-medium text-down';
      else todayProfitElement.className = 'font-medium text-flat';

      if (holdProfit > 0) holdProfitElement.className = 'font-medium text-up';
      else if (holdProfit < 0) holdProfitElement.className = 'font-medium text-down';
      else holdProfitElement.className = 'font-medium text-flat';

      if (totalRate > 0) totalRateElement.className = 'font-medium text-up';
      else if (totalRate < 0) totalRateElement.className = 'font-medium text-down';
      else totalRateElement.className = 'font-medium text-flat';
    }

    // 排序持仓
    function sortPositions() {
      const sortBy = document.getElementById('sort-by').value;
      const sortOrder = document.getElementById('sort-order').value;

      if (sortBy === 'default') {
        positionList = JSON.parse(JSON.stringify(originalPositionList));
      } else {
        positionList.sort((a, b) => {
          let aValue = a[sortBy] || 0;
          let bValue = b[sortBy] || 0;
          
          if (sortOrder === 'asc') {
            return aValue - bValue;
          } else {
            return bValue - aValue;
          }
        });
      }

      renderPositions();
    }

    // 显示 Toast 提示
    function showToast(message) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      
      toastMessage.textContent = message;
      toast.classList.remove('translate-x-full', 'opacity-0');
      
      // 3秒后自动隐藏
      setTimeout(() => {
        toast.classList.add('translate-x-full', 'opacity-0');
      }, 3000);
    }

    // 点击遮罩关闭弹窗
    document.getElementById('position-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closePositionModal();
      }
    });

    // 刷新涨跌榜
    function refreshRanking() {
      // 显示加载状态
      showToast('正在获取涨跌榜数据...');

      // 使用优化的基金代码列表（增加数量以获取更多数据）
      const fundCodes = [
        '000001', '000005', '000015', '000016', '000017',
        '000020', '000021', '000008', '000010', '000011',
        '000012', '000013', '000014', '000018', '000019',
        '000022', '000023', '000024', '000025', '000026',
        '000027', '000028', '000029', '000030', '000031',
        '000032', '000033', '000034', '000035', '000036'
      ];

      // 并行请求所有基金估值
      const promises = fundCodes.map(code => {
        const apiUrl = `http://fundgz.1234567.com.cn/js/${code}.js`;
        const proxyUrl = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(apiUrl)}`;
        return fetch(proxyUrl, {
          method: 'GET',
          cache: 'no-cache'
        })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
          })
          .then(data => {
            try {
              const jsonStr = data.substring(data.indexOf('{'), data.lastIndexOf('}') + 1);
              const fundData = JSON.parse(jsonStr);
              // 计算涨跌幅
              fundData.dayChange = parseFloat(((fundData.gsz - fundData.dwjz) / fundData.dwjz * 100).toFixed(2));
              return fundData;
            } catch (error) {
              return null;
            }
          })
          .catch(error => {
            return null;
          });
      });

      // 处理所有请求结果
      Promise.all(promises)
        .then(results => {
          // 过滤掉无效数据
          const validFunds = results.filter(fund => fund !== null && fund.dayChange !== undefined);

          // 按涨跌幅排序
          validFunds.sort((a, b) => b.dayChange - a.dayChange);

          // 分离上涨榜和下跌榜
          const upRanking = validFunds.filter(fund => fund.dayChange > 0).slice(0, 20);
          const downRanking = validFunds.filter(fund => fund.dayChange < 0).sort((a, b) => a.dayChange - b.dayChange).slice(0, 20);

          // 渲染涨跌榜
          renderRanking('up-ranking-body', upRanking, true);
          renderRanking('down-ranking-body', downRanking, false);

          showToast('涨跌榜数据获取完成');
        })
        .catch(error => {
          console.error('获取涨跌榜数据失败:', error);
          // 使用备用模拟数据
          useMockRankingData();
        });
    }
    
    // 使用模拟涨跌榜数据（备用）
    function useMockRankingData() {
      const mockFunds = Object.values(mockFundData);
      // 按涨跌幅排序
      mockFunds.sort((a, b) => b.dayChange - a.dayChange);
      // 分离上涨榜和下跌榜
      const upRanking = mockFunds.filter(fund => fund.dayChange > 0).slice(0, 20);
      const downRanking = mockFunds.filter(fund => fund.dayChange < 0).sort((a, b) => a.dayChange - b.dayChange).slice(0, 20);
      // 渲染涨跌榜
      renderRanking('up-ranking-body', upRanking, true);
      renderRanking('down-ranking-body', downRanking, false);
      showToast('涨跌榜数据获取完成');
    }
    
    // 自动刷新涨跌榜
    let rankingAutoRefreshInterval = null;
    
    function startRankingAutoRefresh() {
      // 每30秒自动刷新一次
      if (rankingAutoRefreshInterval) {
        clearInterval(rankingAutoRefreshInterval);
      }
      rankingAutoRefreshInterval = setInterval(refreshRanking, 30000);
    }
    
    function stopRankingAutoRefresh() {
      if (rankingAutoRefreshInterval) {
        clearInterval(rankingAutoRefreshInterval);
        rankingAutoRefreshInterval = null;
      }
    }

    // 渲染涨跌榜
    function renderRanking(elementId, funds, isUp) {
      const tbody = document.getElementById(elementId);
      
      // 清空表格
      tbody.innerHTML = '';
      
      // 显示空状态
      if (funds.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="5" class="px-4 py-8 text-center text-gray-500">
            <i class="fa fa-info-circle text-gray-400 text-xl mb-2"></i>
            <p>${isUp ? '暂无上涨基金数据' : '暂无下跌基金数据'}</p>
          </td>
        `;
        tbody.appendChild(row);
        return;
      }

      // 渲染涨跌榜数据
      funds.forEach((fund, index) => {
        const row = document.createElement('tr');
        row.className = 'card-hover';
        
        // 设置涨跌颜色
        let dayChangeClass = 'text-flat';
        if (fund.dayChange > 0) dayChangeClass = 'text-up';
        else if (fund.dayChange < 0) dayChangeClass = 'text-down';

        row.innerHTML = `
          <td class="px-4 py-3 whitespace-nowrap">
            <div class="text-sm font-medium">${index + 1}</div>
          </td>
          <td class="px-4 py-3 whitespace-nowrap">
            <div class="text-sm text-primary cursor-pointer hover:underline" onclick="viewFundDetail('${fund.fundcode}')">${fund.name}</div>
          </td>
          <td class="px-4 py-3 whitespace-nowrap">
            <div class="text-sm text-gray-500">${fund.fundcode}</div>
          </td>
          <td class="px-4 py-3 whitespace-nowrap">
            <div class="text-sm ${dayChangeClass}">${fund.dayChange.toFixed(2)}%</div>
          </td>
          <td class="px-4 py-3 whitespace-nowrap">
            <div class="text-sm">¥${fund.gsz}</div>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // 查看基金详情
    function viewFundDetail(fundCode) {
      // 确保基金代码存在
      if (!fundCode || fundCode.trim() === '') {
        showToast('基金代码无效');
        return;
      }
      
      // 切换到估值查询面板
      switchTab('query');
      
      // 填充基金代码到输入框
      document.getElementById('fund-code').value = fundCode;
      
      // 触发查询操作
      queryFund();
    }
    
    // 快速查询基金
    function quickQueryFund(fundCode) {
      // 填充基金代码到输入框
      document.getElementById('fund-code').value = fundCode;
      
      // 触发查询操作
      queryFund();
    }

    // 返回上一步
    function goBack() {
      if (historyStack.length > 0) {
        const previousTab = historyStack.pop();
        console.log('返回上一步：', previousTab);
        switchTab(previousTab, true);
      }
    }
    
    // 更新返回按钮状态
    function updateBackButton() {
      const backBtn = document.getElementById('back-btn');
      if (backBtn) {
        if (historyStack.length > 0) {
          backBtn.classList.remove('hidden');
        } else {
          backBtn.classList.add('hidden');
        }
      }
    }
    
    // 更新批量删除按钮状态
    function updateBatchDeleteButton() {
      const checkboxes = document.querySelectorAll('.position-checkbox:checked');
      const batchDeleteBtn = document.getElementById('batch-delete-btn');
      if (batchDeleteBtn) {
        batchDeleteBtn.disabled = checkboxes.length === 0;
      }
      // 更新全选复选框状态
      const allCheckboxes = document.querySelectorAll('.position-checkbox');
      const selectAllCheckbox = document.getElementById('select-all-checkbox');
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = allCheckboxes.length > 0 && Array.from(allCheckboxes).every(cb => cb.checked);
      }
    }
    
    // 全选或取消全选所有持仓项
    function selectAllPositions(checked) {
      const checkboxes = document.querySelectorAll('.position-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = checked;
      });
      updateBatchDeleteButton();
    }
    
    // 批量删除选中的持仓项
    function batchDeletePositions() {
      const checkboxes = document.querySelectorAll('.position-checkbox:checked');
      if (checkboxes.length === 0) {
        showToast('请先选择要删除的持仓项');
        return;
      }
      
      if (confirm(`确定要删除${checkboxes.length}个持仓项吗？`)) {
        // 获取选中的索引
        const indexes = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index, 10)).sort((a, b) => b - a);
        
        // 从后往前删除，避免索引错乱
        indexes.forEach(index => {
          positionList.splice(index, 1);
        });
        
        // 保存到本地存储
        localStorage.setItem('positionList', JSON.stringify(positionList));
        localStorage.setItem('originalPositionList', JSON.stringify(positionList));
        
        // 刷新持仓列表
        renderPositions();
        showToast(`成功删除${checkboxes.length}个持仓项`);
      }
    }
    
    // 分享应用
    function shareApp() {
      // 检查是否在本地运行
      const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:';
      
      if (isLocal) {
        // 本地运行，提示用户如何分享
        showToast('本地运行模式，无法直接分享。请部署到网络服务器后再使用分享功能。');
        return;
      }
      
      // 构建分享URL
      const shareUrl = window.location.href;
      
      // 尝试使用Web Share API
      if (navigator.share) {
        navigator.share({
          title: '基金估值查询工具',
          text: '实时查询基金估值，管理你的投资组合',
          url: shareUrl
        })
        .then(() => showToast('分享成功'))
        .catch(error => {
          console.error('分享失败:', error);
          // 降级到复制链接
          copyShareLink(shareUrl);
        });
      } else {
        // 不支持Web Share API，降级到复制链接
        copyShareLink(shareUrl);
      }
    }
    
    // 复制分享链接
    function copyShareLink(url) {
      navigator.clipboard.writeText(url)
        .then(() => {
          showToast('分享链接已复制到剪贴板');
        })
        .catch(error => {
          console.error('复制失败:', error);
          showToast('复制失败，请手动复制链接');
        });
    }
    
    // 切换主题
    function toggleTheme() {
      const body = document.body;
      const themeToggle = document.getElementById('theme-toggle');
      const icon = themeToggle.querySelector('i');
      
      // 切换主题类
      body.classList.toggle('dark-theme');
      
      // 切换图标
      if (icon.classList.contains('fa-sun-o')) {
        icon.classList.remove('fa-sun-o');
        icon.classList.add('fa-moon-o');
        // 应用深色主题样式
        body.classList.add('bg-gray-900', 'text-white');
        body.classList.remove('bg-gray-50', 'text-gray-800');
      } else {
        icon.classList.remove('fa-moon-o');
        icon.classList.add('fa-sun-o');
        // 应用浅色主题样式
        body.classList.add('bg-gray-50', 'text-gray-800');
        body.classList.remove('bg-gray-900', 'text-white');
      }
      
      // 保存主题设置到本地存储
      const isDark = icon.classList.contains('fa-moon-o');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }
    
    // 初始化主题
    function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      const themeToggle = document.getElementById('theme-toggle');
      const icon = themeToggle.querySelector('i');
      const body = document.body;
      
      if (savedTheme === 'dark') {
        // 应用深色主题
        icon.classList.remove('fa-sun-o');
        icon.classList.add('fa-moon-o');
        body.classList.add('bg-gray-900', 'text-white');
        body.classList.remove('bg-gray-50', 'text-gray-800');
      } else {
        // 应用浅色主题
        icon.classList.remove('fa-moon-o');
        icon.classList.add('fa-sun-o');
        body.classList.add('bg-gray-50', 'text-gray-800');
        body.classList.remove('bg-gray-900', 'text-white');
      }
    }
    
    // 根据基金代码获取基金名称
    function getFundNameByCode(code) {
      // 尝试从模拟数据中获取
      if (mockFundData[code]) {
        const fundName = mockFundData[code].name;
        document.getElementById('modal-fund-name-display').textContent = `基金名称：${fundName}`;
        return fundName;
      }
      
      // 尝试从映射表中获取
      for (const [name, fundCode] of Object.entries(fundNameMap)) {
        if (fundCode === code) {
          document.getElementById('modal-fund-name-display').textContent = `基金名称：${name}`;
          return name;
        }
      }
      
      // 未找到，显示默认提示
      document.getElementById('modal-fund-name-display').textContent = '未找到基金名称，请检查代码是否正确';
      return null;
    }
    
    // 计算持有天数
    function calculateHoldDays(tradeDate) {
      if (!tradeDate) return '-';
      const today = new Date();
      const trade = new Date(tradeDate);
      const diffTime = Math.abs(today - trade);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      return diffDays;
    }
    
    // 刷新新闻资讯
    function refreshNews() {
      showToast('正在获取新闻资讯...');
      
      // 尝试从多个新闻API获取数据
      fetchNewsFromAPI()
        .then(newsData => {
          // 渲染新闻列表
          renderNewsList(newsData);
          showToast('新闻资讯获取完成');
        })
        .catch(error => {
          console.error('获取新闻失败:', error);
          // 使用备用模拟数据
          useMockNewsData();
        });
    }
    
    // 自动刷新新闻
    let newsAutoRefreshInterval = null;
    
    function startNewsAutoRefresh() {
      // 每60秒自动刷新一次
      if (newsAutoRefreshInterval) {
        clearInterval(newsAutoRefreshInterval);
      }
      newsAutoRefreshInterval = setInterval(refreshNews, 60000);
    }
    
    function stopNewsAutoRefresh() {
      if (newsAutoRefreshInterval) {
        clearInterval(newsAutoRefreshInterval);
        newsAutoRefreshInterval = null;
      }
    }
    
    // 从API获取新闻
    function fetchNewsFromAPI() {
      return new Promise((resolve, reject) => {
        // 尝试使用新浪财经API（通过CORS代理）
        const apiUrl = 'https://api.codetabs.com/v1/proxy?quest=http://finance.sina.com.cn/stock/newstock/';
        
        fetch(apiUrl, {
          method: 'GET',
          headers: {
            'Content-Type': 'text/html'
          }
        })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
          })
          .then(html => {
            // 解析HTML获取新闻（简化实现）
            const newsData = parseNewsFromHTML(html);
            if (newsData.length > 0) {
              resolve(newsData);
            } else {
              throw new Error('未能解析到新闻数据');
            }
          })
          .catch(error => {
            console.error('新浪财经API失败:', error);
            // 尝试使用备用API
            useAlternativeNewsAPI().then(resolve).catch(reject);
          });
      });
    }
    
    // 使用备用新闻API
    function useAlternativeNewsAPI() {
      return new Promise((resolve, reject) => {
        // 使用模拟数据作为备用
        const mockNewsData = [
          {
            id: 1,
            title: '央行降准0.5个百分点，释放长期资金约1.2万亿元',
            source: '中国证券报',
            time: new Date().toLocaleString('zh-CN'),
            content: '央行决定于近日下调金融机构存款准备金率0.5个百分点（不含已执行5%存款准备金率的金融机构）。此次降准预计将释放长期资金约1.2万亿元，有助于保持流动性合理充裕，降低社会融资成本，支持实体经济发展。业内专家认为，降准将为市场注入流动性，对A股和债市均有正面影响。'
          },
          {
            id: 2,
            title: 'A股三大指数集体上涨，创业板指表现强势',
            source: '上海证券报',
            time: new Date().toLocaleString('zh-CN'),
            content: '今日，A股市场表现强势，三大指数集体上涨。截至收盘，上证指数涨1.23%，深证成指涨1.87%，创业板指涨2.15%。行业板块多数上涨，新能源、半导体、医药等板块领涨。北向资金当日净流入85.6亿元，连续多个交易日净流入。'
          },
          {
            id: 3,
            title: '基金四季报出炉，明星基金经理最新持仓曝光',
            source: '证券时报',
            time: new Date().toLocaleString('zh-CN'),
            content: '最新基金四季报已全部披露完毕，明星基金经理的最新持仓情况曝光。数据显示，多位基金经理在四季度增加了对科技、消费等板块的配置，同时减持了部分周期股。业内分析认为，基金经理的调仓方向反映了对市场的乐观预期。'
          },
          {
            id: 4,
            title: '养老金第三支柱建设加速，个人养老金制度将进一步完善',
            source: '经济日报',
            time: new Date().toLocaleString('zh-CN'),
            content: '国务院近日印发《关于推动个人养老金发展的意见》，提出要加快推进多层次、多支柱养老保险体系建设。业内专家表示，个人养老金制度的完善将为资本市场带来长期稳定的资金来源，有利于资本市场的健康发展。'
          },
          {
            id: 5,
            title: '新能源基金业绩领跑，年内表现突出',
            source: '第一财经',
            time: new Date().toLocaleString('zh-CN'),
            content: '数据显示，今年以来，新能源主题基金表现亮眼，平均收益率超过30%。其中，光伏、风电、新能源车等细分领域的基金表现尤为突出。业内人士认为，随着全球能源转型的加速推进，新能源板块仍有较大的投资机会。'
          },
          {
            id: 6,
            title: '科技创新板再迎重磅政策，支持硬科技企业发展',
            source: '证券日报',
            time: new Date().toLocaleString('zh-CN'),
            content: '证监会近日发布多项政策，进一步支持科技创新板发展，鼓励硬科技企业上市融资。业内专家认为，这将为科技类基金带来更多投资机会，相关主题基金有望受益。'
          },
          {
            id: 7,
            title: '消费升级趋势明显，消费主题基金业绩回暖',
            source: '中国证券报',
            time: new Date().toLocaleString('zh-CN'),
            content: '随着经济复苏和消费升级趋势的明显，消费主题基金业绩开始回暖。数据显示，近一个月来，消费主题基金平均收益率达到8.5%，表现优于大盘。'
          }
        ];
        resolve(mockNewsData);
      });
    }
    
    // 从HTML解析新闻
    function parseNewsFromHTML(html) {
      const newsData = [];
      
      // 简化的HTML解析，提取新闻标题和链接
      // 注意：实际生产环境中应使用更 robust 的解析方法
      const titleRegex = /<a[^>]+href="([^"]+)"[^>]*>([^<]+)<\/a>/g;
      let match;
      let id = 1;
      
      while ((match = titleRegex.exec(html)) && id <= 7) {
        const title = match[2].trim();
        if (title.length > 10 && title.length < 100) {
          newsData.push({
            id: id++,
            title: title,
            source: '新浪财经',
            time: new Date().toLocaleString('zh-CN'),
            content: `新闻详情：${title}...（注：由于API限制，仅显示标题）`
          });
        }
      }
      
      return newsData;
    }
    
    // 使用模拟新闻数据
    function useMockNewsData() {
      const mockNewsData = [
        {
          id: 1,
          title: '央行降准0.5个百分点，释放长期资金约1.2万亿元',
          source: '中国证券报',
          time: new Date().toLocaleString('zh-CN'),
          content: '央行决定于近日下调金融机构存款准备金率0.5个百分点（不含已执行5%存款准备金率的金融机构）。此次降准预计将释放长期资金约1.2万亿元，有助于保持流动性合理充裕，降低社会融资成本，支持实体经济发展。业内专家认为，降准将为市场注入流动性，对A股和债市均有正面影响。',
          image: 'https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=Central%20Bank%20monetary%20policy%20news%20conference%20with%20financial%20charts%20and%20data&image_size=landscape_16_9'
        },
        {
          id: 2,
          title: 'A股三大指数集体上涨，创业板指表现强势',
          source: '上海证券报',
          time: new Date().toLocaleString('zh-CN'),
          content: '今日，A股市场表现强势，三大指数集体上涨。截至收盘，上证指数涨1.23%，深证成指涨1.87%，创业板指涨2.15%。行业板块多数上涨，新能源、半导体、医药等板块领涨。北向资金当日净流入85.6亿元，连续多个交易日净流入。',
          image: 'https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=Stock%20market%20trading%20floor%20with%20rising%20charts%20and%20investors&image_size=landscape_16_9'
        },
        {
          id: 3,
          title: '基金四季报出炉，明星基金经理最新持仓曝光',
          source: '证券时报',
          time: new Date().toLocaleString('zh-CN'),
          content: '最新基金四季报已全部披露完毕，明星基金经理的最新持仓情况曝光。数据显示，多位基金经理在四季度增加了对科技、消费等板块的配置，同时减持了部分周期股。业内分析认为，基金经理的调仓方向反映了对市场的乐观预期。',
          image: 'https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=Fund%20manager%20analyzing%20investment%20reports%20with%20charts&image_size=landscape_16_9'
        },
        {
          id: 4,
          title: '养老金第三支柱建设加速，个人养老金制度将进一步完善',
          source: '经济日报',
          time: new Date().toLocaleString('zh-CN'),
          content: '国务院近日印发《关于推动个人养老金发展的意见》，提出要加快推进多层次、多支柱养老保险体系建设。业内专家表示，个人养老金制度的完善将为资本市场带来长期稳定的资金来源，有利于资本市场的健康发展。',
          image: 'https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=Retirement%20planning%20and%20pension%20fund%20management%20concept&image_size=landscape_16_9'
        },
        {
          id: 5,
          title: '新能源基金业绩领跑，年内表现突出',
          source: '第一财经',
          time: new Date().toLocaleString('zh-CN'),
          content: '数据显示，今年以来，新能源主题基金表现亮眼，平均收益率超过30%。其中，光伏、风电、新能源车等细分领域的基金表现尤为突出。业内人士认为，随着全球能源转型的加速推进，新能源板块仍有较大的投资机会。',
          image: 'https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=Renewable%20energy%20sources%20like%20solar%20and%20wind%20power%20plants&image_size=landscape_16_9'
        },
        {
          id: 6,
          title: '科技创新板再迎重磅政策，支持硬科技企业发展',
          source: '证券日报',
          time: new Date().toLocaleString('zh-CN'),
          content: '证监会近日发布多项政策，进一步支持科技创新板发展，鼓励硬科技企业上市融资。业内专家认为，这将为科技类基金带来更多投资机会，相关主题基金有望受益。',
          image: 'https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=Technology%20innovation%20and%20startup%20companies%20in%20tech%20park&image_size=landscape_16_9'
        },
        {
          id: 7,
          title: '消费升级趋势明显，消费主题基金业绩回暖',
          source: '中国证券报',
          time: new Date().toLocaleString('zh-CN'),
          content: '随着经济复苏和消费升级趋势的明显，消费主题基金业绩开始回暖。数据显示，近一个月来，消费主题基金平均收益率达到8.5%，表现优于大盘。',
          image: 'https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=Consumer%20shopping%20mall%20with%20people%20and%20retail%20stores&image_size=landscape_16_9'
        }
      ];
      
      renderNewsList(mockNewsData);
      showToast('使用最新模拟新闻数据');
    }
    
    // 渲染新闻列表
    function renderNewsList(newsData) {
      const newsContent = document.getElementById('news-content');
      newsContent.innerHTML = '';
      
      newsData.forEach(news => {
        const newsItem = document.createElement('div');
        newsItem.className = 'p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors';
        newsItem.onclick = function() {
          showNewsDetail(news);
        };
        
        newsItem.innerHTML = `
          <h4 class="font-medium text-gray-800 mb-1">${news.title}</h4>
          <div class="flex justify-between items-center text-xs text-gray-500">
            <span>${news.source}</span>
            <span>${news.time}</span>
          </div>
        `;
        
        newsContent.appendChild(newsItem);
      });
    }
    
    // 显示新闻详情
    function showNewsDetail(news) {
      document.getElementById('news-title').textContent = news.title;
      document.getElementById('news-meta').textContent = `${news.source} · ${news.time}`;
      
      // 构建新闻详情内容，支持图片显示
      let newsBodyContent = '';
      
      // 如果有图片，添加图片显示
      if (news.image) {
        newsBodyContent += `<div class="mb-4"><img src="${news.image}" alt="${news.title}" class="w-full h-auto rounded-lg shadow-sm"></div>`;
      }
      
      // 添加新闻内容
      newsBodyContent += `<p>${news.content}</p>`;
      
      document.getElementById('news-body').innerHTML = newsBodyContent;
    }
  </script>
</body>
</html>